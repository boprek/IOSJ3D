name: iOS Build

on:
  workflow_dispatch:
    inputs:
      exportMethod:
        description: "export method (development/adhoc/app-store)"
        required: false
        default: "development"

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          cd ios
          xcodegen generate

      - name: Decode certificates
        if: env.HAS_SIGNING == 'true'
        env:
          P12_BASE64: ${{ secrets.P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          MOBILEPROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
        run: |
          echo "$P12_BASE64" | base64 --decode > signing.p12
          echo "$MOBILEPROVISION_BASE64" | base64 --decode > profile.mobileprovision
          security create-keychain -p "temp_pass" build.keychain
          security import signing.p12 -k ~/Library/Keychains/build.keychain -P "$P12_PASSWORD" -A
          security list-keychains -s ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "temp_pass" ~/Library/Keychains/build.keychain
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build (no signing)
        if: env.HAS_SIGNING != 'true'
        run: |
          cd ios
          xcodebuild -scheme J3DDashboard -configuration Release -sdk iphoneos \
            -derivedDataPath build \
            build CODE_SIGNING_ALLOWED=NO

      - name: Package unsigned IPA (for Sideloadly)
        if: env.HAS_SIGNING != 'true'
        run: |
          cd ios
          APP_PATH="build/Build/Products/Release-iphoneos/J3DDashboard.app"
          if [ ! -d "$APP_PATH" ]; then echo "App not found at $APP_PATH"; exit 1; fi
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r J3DDashboard-unsigned.ipa Payload

      - name: Upload unsigned IPA
        if: env.HAS_SIGNING != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: J3DDashboard-unsigned-ipa
          path: ios/J3DDashboard-unsigned.ipa

      - name: Archive (signed)
        if: env.HAS_SIGNING == 'true'
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
          BUNDLE_ID: com.j3d.dashboard.ios
          EXPORT_METHOD: ${{ github.event.inputs.exportMethod }}
        run: |
          cd ios
          xcodebuild -scheme J3DDashboard -configuration Release -sdk iphoneos \
            -archivePath build/J3DDashboard.xcarchive \
            clean archive \
            DEVELOPMENT_TEAM=$TEAM_ID \
            PRODUCT_BUNDLE_IDENTIFIER=$BUNDLE_ID
          xcodebuild -exportArchive \
            -archivePath build/J3DDashboard.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist <(cat <<EOF
            {
              "method": "${EXPORT_METHOD}",
              "signingStyle": "automatic",
              "destination": "export",
              "stripSwiftSymbols": true,
              "compileBitcode": false
            }
          EOF)

      - name: Upload IPA
        if: env.HAS_SIGNING == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: J3DDashboard-ipa
          path: ios/build/export/*.ipa

    env:
      HAS_SIGNING: ${{ secrets.P12_BASE64 != '' && secrets.MOBILEPROVISION_BASE64 != '' && secrets.TEAM_ID != '' }}
