<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J3D Dashboard</title>
            <style>
                html, body { width: 100%; height: 100%; overflow: hidden; }
                /* Wrapper pantalla completa */
                        #uiScaleWrapper {
                            position: fixed; inset: 0; z-index: 9999; overflow: hidden; background: #000; /* negro para evitar m√°rgenes blancos */
                        }
                /* Contenedor a tama√±o "dise√±o" que se escalar√° con transform */
                #uiContainer {
                    position: absolute; left: 0; top: 0; transform-origin: top left;
                }
                /* El iframe ocupa todo el contenedor de dise√±o */
                #uiIframe { width: 100%; height: 100%; border: none; display: block; }
            </style>
</head>
<body style="font-family: Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh;">
    
    <div id="login" style="max-width: 400px; margin: 50px auto; text-align: center; background: rgba(255,255,255,0.1); padding: 40px; border-radius: 10px; backdrop-filter: blur(10px); display:none;">
        <h1>J3D Dashboard</h1>
        <h2>üîê Login</h2>
        <div style="margin: 20px 0;">
            <input type="text" id="username" placeholder="Usuario" style="width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 5px; font-size: 16px;">
            <input type="password" id="password" placeholder="Contrase√±a" style="width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 5px; font-size: 16px;">
        </div>
        <button onclick="conectar()" style="width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer;">
            üöÄ Conectar
        </button>
        
        <div id="debugLog" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">
            <div style="color: #4CAF50;">[DEBUG] Dashboard iniciado</div>
        </div>
    </div>
    
    <div id="dashboard" style="display: none; text-align: center; margin-top: 30px;">
        <h2>Dashboard Conectado</h2>
        <button onclick="cargarInspeccion()" style="padding: 15px 30px; margin: 10px; font-size: 16px; background: #2196F3; color: white; border: none; border-radius: 5px;">
            üìã Inspection
        </button>
        <button onclick="searchTest()" style="padding: 15px 30px; margin: 10px; font-size: 16px; background: #2196F3; color: white; border: none; border-radius: 5px;">
            üîé Search
        </button>
        
        <button onclick="testHTTP()" style="padding: 15px 30px; margin: 10px; font-size: 16px; background: #607D8B; color: white; border: none; border-radius: 5px;">
            üîß Test HTTP
        </button>
        <button onclick="toggleDebugConsole()" style="padding: 15px 30px; margin: 10px; font-size: 16px; background: #9C27B0; color: white; border: none; border-radius: 5px;">
            üñ•Ô∏è Debug Console
        </button>
        <br>
        <div style="margin: 10px 0; display:flex; flex-wrap:wrap; justify-content:center; gap:8px;">
            <button onclick="cambiarUI('4')" style="padding: 10px 15px; min-width:90px; font-size: 14px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight:600;">
                Cap√≥
            </button>
            <button onclick="cambiarUI('5')" style="padding: 10px 15px; min-width:90px; font-size: 14px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight:600;">
                Techo
            </button>
            <button onclick="cambiarUI('8')" style="padding: 10px 15px; min-width:95px; font-size: 14px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight:600;">
                Port√≥n
            </button>
            <button onclick="cambiarUI('9')" style="padding: 10px 15px; min-width:130px; font-size: 14px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight:600;">
                Lateral Izq.
            </button>
            <button onclick="cambiarUI('12')" style="padding: 10px 15px; min-width:130px; font-size: 14px; background: #FF9800; color: white; border: none; border-radius: 6px; font-weight:600;">
                Lateral Dcha.
            </button>
        </div>
        
        
        <!-- Console de Debug flotante -->
        <div id="debugConsole" style="display: none; position: fixed; top: 10px; left: 10px; right: 10px; max-height: 70vh; background: rgba(0,0,0,0.9); border: 2px solid #9C27B0; border-radius: 10px; z-index: 1000;">
            <div style="padding: 10px; background: #9C27B0; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                <span>üñ•Ô∏è Debug Console - Mensajes en tiempo real</span>
                <button onclick="clearDebugLog()" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; font-size: 12px;">
                    üóëÔ∏è Limpiar
                </button>
            </div>
            <div id="debugMessages" style="padding: 15px; font-family: 'Courier New', monospace; font-size: 11px; max-height: 60vh; overflow-y: auto; color: #00ff00;">
                <div style="color: #4CAF50;">[INIT] Console de debug iniciada</div>
            </div>
        </div>
    </div>

    <script>
            // Abrir Test.html que usa j3dWebSocket.js y util.js
            function searchTest(){
                const rel = 'Test.html';
                let url = rel;
                // En entorno APK (file://), evitar window.open y usar iframe directamente
                const shouldUseIframe = (location.protocol==='file:');
                try{
                    if(!shouldUseIframe){
                        const w = window.open(url, '_blank');
                        if(w){ return; }
                    }
                    // Incrustar iframe
                    let iframe = document.getElementById('testIframe');
                    if(!iframe){
                        iframe = document.createElement('iframe');
                        iframe.id='testIframe';
                        iframe.style.cssText='position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:94%;height:84%;z-index:5000;border:2px solid #fff;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.55);background:#fff;overflow:auto;';
                        // Bot√≥n cerrar
                        const closeBtn = document.createElement('button');
                        closeBtn.textContent = 'Cerrar';
                        closeBtn.style.cssText='position:fixed;right:3%;top:7%;z-index:5001;background:#c62828;color:#fff;border:0;padding:10px 14px;border-radius:10px;font-weight:600;box-shadow:0 6px 16px rgba(0,0,0,.4)';
                        closeBtn.onclick = ()=>{ iframe.remove(); closeBtn.remove(); };
                        document.body.appendChild(closeBtn);
                        document.body.appendChild(iframe);
                    }
                    iframe.src=url;
                    if(typeof PrintMessage==='function') PrintMessage('Abriendo Test.html', '#1976d2', 2000);
                    else console.log('Abriendo Test.html en iframe');
                }catch(e){
                    if(typeof PrintMessage==='function') PrintMessage('No se pudo abrir Test.html: '+e.message, '#e92d3a', 2500);
                    else console.error('No se pudo abrir Test.html:', e);
                }
            }
    let ws = null;
    // Desactivar login: siempre considerar sesi√≥n activa
    let isLoggedIn = true;
        
        // Funci√≥n para escribir en el log de debug
        function debugLog(message, type = "info") {
            const logDiv = document.getElementById("debugLog");
            const messagesDiv = document.getElementById("debugMessages");
            const timestamp = new Date().toLocaleTimeString();
            
            let color = "#00ff00";
            let icon = "‚ÑπÔ∏è";
            
            switch(type) {
                case "error":
                    color = "#ff4444";
                    icon = "‚ùå";
                    break;
                case "warning":
                    color = "#ffaa00";
                    icon = "‚ö†Ô∏è";
                    break;
                case "success":
                    color = "#4CAF50";
                    icon = "‚úÖ";
                    break;
                case "send":
                    color = "#2196F3";
                    icon = "üì§";
                    break;
                case "receive":
                    color = "#9C27B0";
                    icon = "üì•";
                    break;
            }
            
            const logEntry = `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${icon} ${message}</div>`;
            
            if (logDiv) {
                logDiv.innerHTML += logEntry;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            
            if (messagesDiv) {
                messagesDiv.innerHTML += logEntry;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        
        // Funci√≥n para alternar la console de debug
        function toggleDebugConsole() {
            const console = document.getElementById("debugConsole");
            if (console.style.display === "none") {
                console.style.display = "block";
                debugLog("Console de debug mostrada", "info");
            } else {
                console.style.display = "none";
            }
        }

        // Inicializar vista seg√∫n estado de login guardado
        (function initView() {
            try {
                // Mostrar siempre el dashboard y conectar autom√°ticamente
                document.getElementById("login").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                debugLog("üîì Login deshabilitado: mostrando dashboard", "info");
                // Intentar conexi√≥n autom√°tica
                setTimeout(() => conectar(), 200);
            } catch (e) {
                debugLog(`‚ö†Ô∏è Error initView: ${e.message}`, "warning");
            }
        })();
        
        // Funci√≥n para limpiar el log de debug
        function clearDebugLog() {
            const messagesDiv = document.getElementById("debugMessages");
            if (messagesDiv) {
                messagesDiv.innerHTML = '<div style="color: #4CAF50;">[CLEAR] Log limpiado</div>';
            }
        }

        function conectar() {
            // Conexi√≥n sin credenciales: login eliminado
            debugLog(`Intentando conectar (login deshabilitado)`, "info");
            
            try {
                // Usar la interfaz nativa de Android
                if (window.AndroidWebSocket) {
                    debugLog("Usando interfaz Android nativa", "info");
                    window.AndroidWebSocket.connect("ws://172.25.16.63:8192/websocket");
                    
                    // El comando Name se enviar√° autom√°ticamente cuando se abra la conexi√≥n
                    // Ver funci√≥n onWebSocketOpen() m√°s abajo
                    
                } else {
                    debugLog("Interfaz Android no disponible, usando WebSocket directo", "warning");
                    
                    // Conexi√≥n WebSocket directa para pruebas
                    ws = new WebSocket("ws://172.25.16.63:8192/websocket");
                    
                    ws.onopen = function(event) {
                        debugLog("‚úÖ Conexi√≥n WebSocket abierta", "success");
                        
                        // Enviar comando Name seg√∫n el formato correcto
                        const nameCommand = {
                            "id": "dashboard_" + Date.now(),
                            "info": "Name",
                            "Name": "Dashboard"
                        };
                        
                        debugLog(`üì§ Enviando Name: ${JSON.stringify(nameCommand)}`, "send");
                        ws.send(JSON.stringify(nameCommand));
                    };
                    
                    ws.onmessage = function(event) {
                        debugLog(`üì• Recibido: ${event.data}`, "receive");
                        
                        // Si recibimos confirmaci√≥n, mostrar dashboard
                        if (event.data.includes("Name") || event.data.includes("OK")) {
                            debugLog("üîê Login exitoso", "success");
                            mostrarDashboard();
                        }
                    };
                    
                    ws.onerror = function(error) {
                        debugLog(`‚ùå Error WebSocket: ${error}`, "error");
                    };
                    
                    ws.onclose = function(event) {
                        debugLog("üîå Conexi√≥n WebSocket cerrada", "warning");
                    };
                }
                
            } catch (error) {
                debugLog(`‚ùå Error de conexi√≥n: ${error.message}`, "error");
            }
        }
        
        function mostrarDashboard() {
            document.getElementById("login").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            isLoggedIn = true;
            try { localStorage.setItem('isLoggedIn','true'); } catch(e) {}
            debugLog("üì± Dashboard mostrado", "success");
        }
        
        function cargarInspeccion() {
            debugLog("üìã Cargando m√≥dulo Inspection...", "info");
            debugLog("Enviando comandos al servidor J3D...", "info");
            
            try {
                // 1. Enviar comandos WebSocket b√°sicos (Name, ReadFile, GetStatus)
                if (window.AndroidWebSocket) {
                    const nameCommand = {
                        "id": "name_" + Date.now(),
                        "info": "Name",
                        "Name": "Dashboard"
                    };
                    debugLog(`üì§ Enviando Name: ${JSON.stringify(nameCommand)}`, "send");
                    window.AndroidWebSocket.send(JSON.stringify(nameCommand));
                    
                    setTimeout(() => {
                        const readFileCommand = {
                            "id": "readfile_" + Date.now(),
                            "info": "ReadFile",
                            "path": "./Dash.cfg",
                            "type": "cfg"
                        };
                        debugLog(`üì§ Enviando ReadFile: ${JSON.stringify(readFileCommand)}`, "send");
                        window.AndroidWebSocket.send(JSON.stringify(readFileCommand));
                        
                        const statusCommand = {
                            "id": "status_" + Date.now(),
                            "info": "GetStatus"
                        };
                        debugLog(`üì§ Enviando GetStatus: ${JSON.stringify(statusCommand)}`, "send");
                        window.AndroidWebSocket.send(JSON.stringify(statusCommand));
                    }, 100);
                    
                } else if (ws && ws.readyState === WebSocket.OPEN) {
                    // Fallback para WebSocket directo
                    const nameCommand = {
                        "id": "name_" + Date.now(),
                        "info": "Name",
                        "Name": "Dashboard"
                    };
                    ws.send(JSON.stringify(nameCommand));
                }
                
                // 2. Realizar llamada HTTP obligatoria a /1 (como Dashboard original)
                setTimeout(() => {
                    debugLog("üåê Realizando llamada HTTP obligatoria a /1...", "info");
                    const xhr1 = new XMLHttpRequest();
                    xhr1.onload = function() {
                        debugLog(`üì• Respuesta HTTP /1: ${xhr1.status} ${xhr1.statusText}`, "receive");
                        debugLog("‚úÖ Llamada /1 completada - iniciando fetchUI", "success");
                        
                        // 3. Iniciar fetchUI constante despu√©s de /1
                        startFetchUI();
                    };
                    xhr1.onerror = function() {
                        debugLog("‚ö†Ô∏è HTTP /1 fall√≥ - iniciando fetchUI anyway", "warning");
                        debugLog("‚ÑπÔ∏è El WebSocket funciona, continuando con fetchUI...", "info");
                        
                        // Iniciar fetchUI aunque falle el /1
                        startFetchUI();
                    };
                    xhr1.ontimeout = function() {
                        debugLog("‚ö†Ô∏è HTTP /1 timeout - iniciando fetchUI anyway", "warning");
                        startFetchUI();
                    };
                    xhr1.timeout = 3000; // 3 segundos timeout
                    xhr1.open('GET', "http://172.25.16.63:8192/1");
                    xhr1.send();
                }, 200);
                    
            } catch (error) {
                debugLog(`‚ùå Error cargando Inspection: ${error.message}`, "error");
            }
        }
        
        // Variable para controlar fetchUI
        let fetchUIInterval = null;
        // Bloqueo (LOCK) para pausar el auto-refresco de la UI
        let uiLockEnabled = false;
        try { uiLockEnabled = (localStorage.getItem('uiLockEnabled') === 'true'); } catch(e) {}
        // Lista de UIs disponibles para inspecci√≥n (zonas veh√≠culo)
        const AVAILABLE_UI_VALUES = ["4","5","8","9","12"]; 
        let currentUIValue = AVAILABLE_UI_VALUES[0]; // Valor por defecto - Cap√≥ (UI 4)
        
        // Funci√≥n para iniciar el fetchUI constante
        function startFetchUI() {
            debugLog("üîÑ Iniciando fetchUI constante...", "info");
            debugLog(`üîç currentUIValue inicial: ${currentUIValue}`, "info");
            
            // Asegurar que tenemos un valor v√°lido
            if (!currentUIValue || !AVAILABLE_UI_VALUES.includes(currentUIValue)) {
                currentUIValue = AVAILABLE_UI_VALUES[0];
                debugLog(`üîß Corrigiendo currentUIValue a valor permitido: ${currentUIValue}`, "warning");
            }
            
            // Limpiar intervalo anterior si existe
            if (fetchUIInterval) {
                clearInterval(fetchUIInterval);
            }
            
            // Si est√° activado el LOCK, no iniciar ni ejecutar fetchUI
            if (uiLockEnabled) {
                debugLog("‚è∏Ô∏è UI LOCK activo: no se iniciar√° auto-refresh", "warning");
                // Mostrar una vez la UI actual sin programar refresco
                cargarUIDirectamente();
                updateUILockButton();
                return;
            }
            
            // Funci√≥n fetchUI SIMPLIFICADA - carga directamente en iframe
            function fetchUI() {
                // Si est√° activado el LOCK, no refrescar
                if (uiLockEnabled) {
                    debugLog("‚è∏Ô∏è UI LOCK activo: cancelando fetchUI", "warning");
                    return;
                }
                // Verificar y corregir currentUIValue antes de cada fetch
                if (!currentUIValue || !AVAILABLE_UI_VALUES.includes(currentUIValue)) {
                    currentUIValue = AVAILABLE_UI_VALUES[0];
                    debugLog(`üîß currentUIValue corregido a valor permitido: ${currentUIValue}`, "warning");
                }
                
                debugLog(`üåê Iniciando carga UI: ui_${currentUIValue}.0.html`, "info");
                debugLog(`‚úÖ ESTRATEGIA: Iframe directo (sin fetch/XMLHttpRequest)`, "success");
                
                // SOLUCI√ìN SIMPLE: iframe directo (sin fetch/XMLHttpRequest)
                cargarUIDirectamente();
            }

            
            // Ejecutar inmediatamente
            fetchUI();
            
            // Repetir cada 3 segundos para evitar spam al servidor con errores
            fetchUIInterval = setInterval(fetchUI, 3000);
        }
        
        // Funci√≥n para optimizar HTML para TC22
        function optimizeHTMLForTC22(htmlContent) {
            let optimizedHTML = htmlContent;
            
            // A√±adir viewport si no existe
            if (!optimizedHTML.includes('viewport')) {
                optimizedHTML = optimizedHTML.replace(
                    '<head>',
                    '<head><meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=3.0, user-scalable=yes">'
                );
            }
            
            // Estilos para TC22 horizontal (1024x768)
            const tc22Styles = `
                <style>
                    body { 
                        margin: 0 !important; 
                        padding: 0 !important; 
                        width: 100vw !important;
                        height: 100vh !important;
                        overflow: auto !important;
                        font-size: 14px !important;
                    }
                    svg { 
                        width: 100% !important; 
                        height: auto !important; 
                        max-width: none !important;
                        min-height: 90vh !important;
                    }
                    .inspeccion { 
                        font-size: 12px !important; 
                        padding: 2px !important;
                    }
                    .info1 { 
                        padding: 3px !important; 
                        font-size: 11px !important;
                    }
                    #cuerpo { 
                        width: 100% !important; 
                        overflow-x: auto !important; 
                    }
                    #inspecciones_doble { 
                        display: flex !important; 
                        flex-wrap: wrap !important; 
                    }
                    /* Optimizaci√≥n para TC22 1024x768 horizontal */
                    @media screen and (max-width: 1024px) and (orientation: landscape) {
                        body { font-size: 13px !important; }
                        svg { min-height: 85vh !important; }
                    }
                </style>
            `;
            optimizedHTML = optimizedHTML.replace('</head>', tc22Styles + '</head>');
            
            return optimizedHTML;
        }
        
        // Funci√≥n para mostrar UI de error cuando no se puede cargar
        function mostrarUIError() {
            const errorHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=0.8">
                    <title>Error - UI No Disponible</title>
                </head>
                <body style="font-family: Arial, sans-serif; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <h1>‚ö†Ô∏è UI No Disponible</h1>
                    <p style="font-size: 18px; text-align: center; max-width: 600px;">
                        No se pudo cargar la interfaz UI ${currentUIValue} desde el servidor J3D.
                    </p>
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h3>Posibles causas:</h3>
                        <ul style="text-align: left;">
                            <li>Servidor HTTP del J3D no habilitado</li>
                            <li>Archivo ui_${currentUIValue}.0.html no existe</li>
                            <li>Problema de red o firewall</li>
                            <li>CORS bloqueado</li>
                        </ul>
                    </div>
                    <p style="font-size: 14px; opacity: 0.8;">
                        WebSocket: ‚úÖ Funcionando | HTTP: ‚ùå Error de conexi√≥n
                    </p>
                </body>
                </html>
            `;
            
            if (!document.getElementById("uiIframe")) {
                mostrarUICompleta(errorHTML);
            } else {
                const iframe = document.getElementById("uiIframe");
                if (iframe) {
                    iframe.srcdoc = errorHTML;
                }
            }
            
            debugLog("‚ùå Mostrando UI de error por fallos HTTP", "error");
        }
        
        // Funci√≥n para mostrar UI en pantalla completa
        function mostrarUICompleta(htmlContent) {
            // Ocultar dashboard y mostrar iframe
            document.getElementById("dashboard").style.display = "none";
            
            // Crear iframe de pantalla completa
            const iframe = document.createElement("iframe");
            iframe.id = "uiIframe";
            iframe.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                border: none;
                z-index: 9999;
                background: white;
            `;
            
            // Bot√≥n para volver (reposicionado abajo para no tapar cabecera)
            const backBtn = document.createElement("button");
            backBtn.innerHTML = "‚Üê Volver";
            backBtn.id = "backButton";
            backBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                z-index: 10000;
                padding: 12px 26px;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 8px;
                font-size: 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,.4);
                cursor: pointer;
            `;
            backBtn.onclick = function() { cerrarUI(); };
            
            // Optimizar y cargar contenido
            iframe.srcdoc = optimizeHTMLForTC22(htmlContent);
            
            document.body.appendChild(iframe);
            document.body.appendChild(backBtn);
            
            debugLog("üì± UI mostrada en pantalla completa para TC22", "success");
        }
        
        function createResponsiveUIFrame(url) {
            debugLog("Creando iframe responsive para UI...", "info");
            // Implementaci√≥n similar a cargarUIDirectamente() pero con URL externo
            const iframe = document.createElement('iframe');
            debugLog(`Cargando URL: {url}`, "info");
            iframe.src = url;
            if (window.AndroidWebSocket && AndroidWebSocket.enterInspectionOrientation) {
                AndroidWebSocket.enterInspectionOrientation();
                debugLog("UI Responsive creado");
            }
            return iframe;
        }
        // SOLUCI√ìN SIMPLE: Cargar URL directamente en iframe (sin fetch/XMLHttpRequest)
        function cargarUIDirectamente() {
            debugLog("üéØ SOLUCI√ìN SIMPLE: Cargando URL directamente en iframe", "info");
            
            const url = `ui_${currentUIValue}.0.html`;
            debugLog(`üîó URL local (assets): ${url}`, "info");
            debugLog(`‚úÖ Cargando UI desde assets con ruta relativa`, "info");
            
            // Cambiar orientaci√≥n a landscape para la UI de inspecci√≥n
            if (window.AndroidWebSocket && AndroidWebSocket.enterInspectionOrientation) {
                AndroidWebSocket.enterInspectionOrientation();
                debugLog("üì± Orientaci√≥n cambiada a landscape", "info");
            }
            
            // Ocultar dashboard
            document.getElementById("dashboard").style.display = "none";
            
            // Crear estructura escalable si no existe
            if (!document.getElementById("uiScaleWrapper")) {
                const wrapper = document.createElement('div');
                wrapper.id = 'uiScaleWrapper';
                wrapper.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    overflow: hidden;
                    background: black;
                `;
                const container = document.createElement('div');
                container.id = 'uiContainer';
                // Tama√±o real de la UI generada (1920x1080)
                const BASE_W = 1920, BASE_H = 1080;
                container.style.cssText = `
                    position: absolute;
                    width: ${BASE_W}px;
                    height: ${BASE_H}px;
                    transform-origin: top left;
                `;
                const iframe = document.createElement('iframe');
                iframe.id = 'uiIframe';
                iframe.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border: none;
                `;
                container.appendChild(iframe);
                wrapper.appendChild(container);
                
                // Bot√≥n para volver (reposicionado abajo para no tapar cabecera)
                const backBtn = document.createElement("button");
                backBtn.innerHTML = "‚Üê Volver";
                backBtn.id = "backButton";
                backBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    z-index: 10000;
                    padding: 12px 26px;
                    background: #f44336;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,.4);
                    cursor: pointer;
                `;
                backBtn.onclick = function() { cerrarUI(); };
                
                // Cargar URL directamente (SIN fetch, SIN XMLHttpRequest)
                iframe.src = url;
                
                iframe.onload = function() {
                    debugLog("‚úÖ ¬°IFRAME CARGADO! URL directa funcion√≥", "success");
                };
                
                iframe.onerror = function(error) {
                    debugLog(`‚ùå Error en iframe: ${error}`, "error");
                };
                // Insertar en DOM
                document.body.appendChild(wrapper);
                document.body.appendChild(backBtn);
                
                // Bot√≥n LOCK para pausar/reanudar auto-refresh
                const lockBtn = document.createElement("button");
                lockBtn.id = "lockButton";
                lockBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 10000;
                    padding: 12px 26px;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    box-shadow: 0 4px 12px rgba(0,0,0,.4);
                    cursor: pointer;
                `;
                lockBtn.onclick = function() { toggleUILock(); };
                document.body.appendChild(lockBtn);
                updateUILockButton();
                
                // Escalado responsivo - contain (cabe todo sin scroll)
                function fitScene() {
                    const vw = window.innerWidth, vh = window.innerHeight;
                    // contain: todo el contenido visible, sin scroll (reduce si es necesario)
                    const scale = Math.min(vw / BASE_W, vh / BASE_H);
                    container.style.transform = `scale(${scale})`;
                    // Centrar contenido
                    const dx = (vw - BASE_W * scale) / 2;
                    const dy = (vh - BASE_H * scale) / 2;
                    container.style.left = `${dx}px`;
                    container.style.top = `${dy}px`;
                    
                    debugLog(`üìê Escalado: ${scale.toFixed(3)}x (${vw}x${vh} ‚Üí ${BASE_W}x${BASE_H})`, "info");
                }
                window.addEventListener('resize', fitScene);
                window.addEventListener('orientationchange', () => setTimeout(fitScene, 100));
                fitScene();

                debugLog("üì∫ UI escalable creada - esperando carga...", "info");
            } else {
                // Actualizar iframe existente
                const iframe = document.getElementById("uiIframe");
                iframe.src = url;
                debugLog("üîÑ Iframe actualizado con nueva URL", "info");
                // Asegurar que el bot√≥n LOCK refleja el estado actual
                updateUILockButton();
            }
        }
        
        // Funci√≥n para cambiar UI manualmente
        function cambiarUI(nuevoUI) {
            if(!AVAILABLE_UI_VALUES.includes(nuevoUI.toString())){
                debugLog(`‚ö†Ô∏è Intento de UI no permitida: ${nuevoUI}`, "warning");
                return;
            }
            currentUIValue = nuevoUI.toString();
            debugLog(`üîÑ Zona seleccionada => UI ${currentUIValue}`, "info");
        }
        
        // Funci√≥n para testear HTTP del servidor J3D
        function testHTTP() {
            debugLog("üîß === INICIANDO TEST HTTP COMPLETO ===", "info");
            
            const tests = [
                "http://172.25.16.63:8192/",
                "http://172.25.16.63:8192/1",
                "http://172.25.16.63:8192/C:/J3D/UI/ui_4.0.html",
                "http://172.25.16.63:8192/C:/J3D/UI/",
                "http://172.25.16.63:8192/UI/ui_4.0.html"
            ];
            
            tests.forEach((url, index) => {
                setTimeout(() => {
                    debugLog(`üîç Test ${index + 1}: ${url}`, "info");
                    
                    const xhr = new XMLHttpRequest();
                    xhr.onload = function() {
                        debugLog(`‚úÖ Test ${index + 1} - Status: ${xhr.status} ${xhr.statusText}`, "success");
                        debugLog(`üìÑ Test ${index + 1} - Content: ${xhr.responseText.substring(0, 200)}...`, "receive");
                    };
                    xhr.onerror = function() {
                        debugLog(`‚ùå Test ${index + 1} - ERROR DE RED`, "error");
                    };
                    xhr.ontimeout = function() {
                        debugLog(`‚è∞ Test ${index + 1} - TIMEOUT`, "warning");
                    };
                    xhr.timeout = 5000;
                    xhr.open('GET', url);
                    xhr.send();
                }, index * 1000);
            });
        }
        
        // Funci√≥n para cerrar UI y volver al dashboard
        function cerrarUI() {
            // Limpiar intervalo fetchUI
            if (fetchUIInterval) {
                clearInterval(fetchUIInterval);
                fetchUIInterval = null;
            }
            
            // Remover wrapper/iframe y bot√≥n
            const wrapper = document.getElementById("uiScaleWrapper");
            const iframe = document.getElementById("uiIframe");
            const backBtn = document.getElementById("backButton");
            const lockBtn = document.getElementById("lockButton");
            if (wrapper) wrapper.remove();
            if (iframe) iframe.remove();
            if (backBtn) backBtn.remove();
            if (lockBtn) lockBtn.remove();
            
            // Volver orientaci√≥n a portrait
            if (window.AndroidWebSocket && AndroidWebSocket.exitInspectionOrientation) {
                AndroidWebSocket.exitInspectionOrientation();
                debugLog("üì± Orientaci√≥n cambiada a portrait", "info");
            }

            // Mostrar dashboard
            document.getElementById("dashboard").style.display = "block";
            
            debugLog("üîô Vuelto al dashboard", "info");
        }
        
        // ====== LOCK helpers ======
        function updateUILockButton() {
            const btn = document.getElementById('lockButton');
            if (!btn) return;
            if (uiLockEnabled) {
                btn.textContent = 'üîí';
                btn.style.background = '#FF9800';
                btn.title = 'Auto-refresh pausado. Toca para desbloquear.';
            } else {
                btn.textContent = 'üîì ';
                btn.style.background = '#4CAF50';
                btn.title = 'Auto-refresh activo. Toca para bloquear.';
            }
        }

        function toggleUILock() {
            uiLockEnabled = !uiLockEnabled;
            try { localStorage.setItem('uiLockEnabled', uiLockEnabled ? 'true' : 'false'); } catch(e) {}
            if (uiLockEnabled) {
                if (fetchUIInterval) { clearInterval(fetchUIInterval); fetchUIInterval = null; }
                debugLog('‚è∏Ô∏è LOCK activado: auto-refresh detenido', 'warning');
            } else {
                debugLog('‚ñ∂Ô∏è LOCK desactivado: auto-refresh reanudado', 'success');
                startFetchUI();
            }
            updateUILockButton();
        }
        
        function toggleScreens(){
            uiLockEnabled = !uiLockEnabled;
            try { localStorage.setItem('uiLockEnabled', uiLockEnabled ? 'true' : 'false'); } catch(e) {}
            if (uiLockEnabled) {
                if (fetchUIInterval) { clearInterval(fetchUIInterval); fetchUIInterval = null;}
                debugLog('Lock activado: auto-refresh detenido', ' warning');
            } else {
                debugLog('Lock desac')
            }
        }
        function cargarReportes() {
            debugLog("üìä Cargando m√≥dulo Search...", "info");
            debugLog("Enviando comandos al servidor J3D...", "info");
            
            try {
                // 1. Enviar comandos WebSocket para Search
                if (window.AndroidWebSocket) {
                    const searchCommand = {
                        "id": "search_" + Date.now(),
                        "info": "Search",
                        "Query": "*"
                    };
                    debugLog(`üì§ Enviando Search: ${JSON.stringify(searchCommand)}`, "send");
                    window.AndroidWebSocket.send(JSON.stringify(searchCommand));
                    
                } else if (ws && ws.readyState === WebSocket.OPEN) {
                    const searchCommand = {
                        "id": "search_" + Date.now(),
                        "info": "Search",
                        "Query": "*"
                    };
                    debugLog(`üì§ Enviando Search: ${JSON.stringify(searchCommand)}`, "send");
                    ws.send(JSON.stringify(searchCommand));
                }
                
                // 2. Realizar llamada HTTP para Search usando XMLHttpRequest
                debugLog("üåê Realizando llamada HTTP para Search...", "info");
                const xhrSearch = new XMLHttpRequest();
                xhrSearch.onload = function() {
                    debugLog(`üì• Respuesta HTTP Search: ${xhrSearch.status} ${xhrSearch.statusText}`, "receive");
                    debugLog(`üì• Datos Search recibidos: ${xhrSearch.responseText.substring(0, 200)}...`, "receive");
                    debugLog("‚úÖ M√≥dulo Search cargado correctamente", "success");
                };
                xhrSearch.onerror = function() {
                    debugLog("‚ùå Error HTTP Search: No se pudo conectar", "error");
                };
                xhrSearch.open('GET', "http://172.25.16.63:8192/search");
                xhrSearch.send();
                    
            } catch (error) {
                debugLog(`‚ùå Error cargando Search: ${error.message}`, "error");
            }
        }
        
        function desconectar() {
            debugLog("üîå Desconectando...", "info");
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            if (window.AndroidWebSocket) {
                window.AndroidWebSocket.close();
            }
            // Mantener el dashboard visible; no volver al login
            document.getElementById("dashboard").style.display = "block";
            document.getElementById("login").style.display = "none";
            try { localStorage.setItem('isLoggedIn','true'); } catch(e) {}
            document.getElementById("debugConsole").style.display = "none";
            isLoggedIn = true;
            debugLog("‚úÖ Desconexi√≥n completa (login deshabilitado)", "success");
        }
        
        // Callback para recibir mensajes desde Android
        function onWebSocketMessage(message) {
            debugLog(`üì• Mensaje desde Android: ${message || '[MENSAJE VAC√çO]'}`, "receive");
            
            if (!message || message.trim() === '') {
                debugLog(`‚ö†Ô∏è Mensaje vac√≠o recibido`, "warning");
                return;
            }
            
            try {
                const data = JSON.parse(message);
                debugLog(`üìã Procesando mensaje: ${data.info || 'unknown'}`, "info");
                
                // Procesar seg√∫n tipo de mensaje
                if (data.info === "ResultadoReadFile") {
                    debugLog(`ÔøΩ Archivo le√≠do: ${data.type}`, "success");
                } else if (data.info === "ResultadoGetStatus") {
                    debugLog(`üîç Status: ${data.status}`, "success");
                } else if (data.info === "UserAction") {
                    debugLog(`üë§ Acci√≥n usuario: ${data.action} - ${data.result}`, data.result === "OK" ? "success" : "error");
                }
                
            } catch (error) {
                debugLog(`‚ö†Ô∏è Mensaje no JSON: ${message}`, "warning");
            }
        }
        
        // Callback para errores de WebSocket desde Android
        function onWebSocketError(error) {
            debugLog(`‚ùå Error WebSocket desde Android: ${error}`, "error");
            debugLog("üîÑ Intentando reconectar...", "warning");
            
            // Mostrar error al usuario
            alert("Error de conexi√≥n WebSocket: " + error + "\nVerifica que el servidor J3D est√© ejecut√°ndose en 172.25.16.63:8192");
        }
        
        // Callback para cuando se abre la conexi√≥n WebSocket
        function onWebSocketOpen() {
            debugLog("‚úÖ Conexi√≥n WebSocket abierta desde Android", "success");
            
            // Ahora que la conexi√≥n est√° abierta, enviar el comando Name
            const nameCommand = {
                "id": "dashboard_" + Date.now(),
                "info": "Name",
                "Name": "Dashboard"
            };
            debugLog(`üì§ Enviando Name: ${JSON.stringify(nameCommand)}`, "send");
            window.AndroidWebSocket.send(JSON.stringify(nameCommand));
            
            // Esperar un poco y mostrar dashboard
            setTimeout(() => {
                debugLog("üîê Login exitoso", "success");
                mostrarDashboard();
            }, 1000);
        }
        
        // Callback para cuando se cierra la conexi√≥n WebSocket
        function onWebSocketClose() {
            debugLog("üîå Conexi√≥n WebSocket cerrada desde Android", "warning");
        }
        
        // ============= COMUNICACI√ìN CON IFRAME (UI) =============
        // Sistema de mensajes para que el iframe pueda enviar comandos WebSocket
        window.addEventListener('message', function(event) {
            debugLog(`üì® Mensaje recibido del iframe: ${JSON.stringify(event.data)}`, "receive");
            
            // Verificar que el mensaje viene de un iframe de confianza
            const data = event.data;
            
            if (data.type === 'WEBSOCKET_REQUEST') {
                // El iframe quiere enviar algo por WebSocket
                debugLog(`üîÑ Reenviando petici√≥n WebSocket: ${data.command}`, "send");
                
                try {
                    if (window.AndroidWebSocket) {
                        window.AndroidWebSocket.send(data.command);
                        debugLog(`‚úÖ Petici√≥n enviada via AndroidWebSocket`, "success");
                        
                        // Enviar confirmaci√≥n al iframe
                        const iframe = document.getElementById('uiIframe');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'WEBSOCKET_SENT',
                                success: true
                            }, '*');
                        }
                    } else {
                        debugLog(`‚ùå AndroidWebSocket no disponible`, "error");
                        // Enviar error al iframe
                        const iframe = document.getElementById('uiIframe');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'WEBSOCKET_ERROR',
                                error: 'AndroidWebSocket no disponible'
                            }, '*');
                        }
                    }
                } catch (error) {
                    debugLog(`‚ùå Error enviando WebSocket: ${error.message}`, "error");
                    const iframe = document.getElementById('uiIframe');
                    if (iframe && iframe.contentWindow) {
                        iframe.contentWindow.postMessage({
                            type: 'WEBSOCKET_ERROR',
                            error: error.message
                        }, '*');
                    }
                }
            } else if (data.type === 'CLOSE_UI') {
                // El iframe quiere cerrarse
                debugLog(`üö™ Iframe solicita cierre`, "info");
                cerrarUI();
            }
        });
        
        // Inicializaci√≥n
        debugLog("üöÄ Aplicaci√≥n J3D iniciada", "success");
        debugLog("üì± Versi√≥n m√≥vil con debug console", "info");
        debugLog("üì° Sistema de comunicaci√≥n iframe-parent activado", "info");
    </script>
</body>
</html>